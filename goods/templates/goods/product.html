{% extends "base.html" %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet">

<div class="container py-4">

    <div class="row align-items-center mb-4">
        <div class="col d-flex flex-wrap gap-3">
            <!-- Каталог -->
            <div class="dropdown">
                <button class="btn btn-dark dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span>Каталог</span>
                    <img class="ms-2" src="{% static 'deps/icons/grid-fill.svg' %}" alt="Catalog Icon" width="16" height="16">
                </button>
                {% include "includes/catalog_dropdown.html" %}
            </div>

            <!-- Корзина -->
            {% include "includes/cart_button.html" %}

            {% if user.is_admin or user.is_staff %}
            <div class="row mb-4">
                <div class="col">
                    <a href="{% url 'admin:goods_product_change' variant.product.id %}" 
                    class="btn btn-dark d-inline-flex align-items-center">
                        Редактировать в админке
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow border-0 mb-5">
        <div class="row g-4 p-4 align-items-start">

            <!-- Галерея -->
            <div class="col-lg-6">
                <div class="mb-3">
                    <img
                        src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'deps/images/Not found image.png' %}{% endif %}"
                        class="img-fluid rounded w-100"
                        alt="{{ product.name }}">
                </div>

                {% if product.image or product.images.all %}
                <div class="d-flex flex-wrap gap-2" id="lightgallery">
                    {% if product.image %}
                        <a href="{{ product.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ product.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endif %}

                    {% for image in product.images.all %}
                        <a href="{{ image.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ image.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Информация о товаре -->
            <div class="col-lg-6">
                <div class="card-body">

                    <h2 class="card-title fw-bold mb-3">{{ product.name }}</h2>


                    {% if product.firm %}
                        <p class="mb-2"><strong>Производитель:</strong> {{ product.firm }}</p>
                    {% endif %}

                    {% if product.composition %}
                        <p class="mb-2"><strong>Состав:</strong> {{ product.composition }}</p>
                    {% endif %}

                    {% if product.model %}
                        <p class="mb-2"><strong>Модель:</strong> {{ product.model }}</p>
                    {% endif %}

                    {% if product.country %}
                        <p class="mb-2"><strong>Страна:</strong> {{ product.country }}</p>
                    {% endif %}

                    {% if variant %}
                        <div id="variant-info">
                            <p class="mb-2"><strong>Артикул:</strong> <span id="variant-sku">{{ variant.sku }}</span></p>
                            <p class="mb-2">
                                <strong>Цена:</strong>
                                {% if variant.discount and variant.discount > 0 %}
                                    <span class="fs-4 text-success fw-bold" id="variant-price">{{ variant.sell_price }} ₽</span>
                                    <span class="text-muted text-decoration-line-through ms-2" id="variant-old-price">{{ variant.price }} ₽</span>
                                    <span class="badge bg-warning ms-2" id="variant-discount">-{{ variant.discount }}%</span>
                                {% else %}
                                    <span  id="variant-price" class="fs-4 fw-bold">{{ variant.sell_price }} ₽</span>
                                    <span id="variant-old-price" class="text-muted text-decoration-line-through ms-2" style="display: none;">{{ variant.price }} ₽</span>
                                    <span id="variant-discount" class="badge bg-warning ms-2" style="display: none;">-{{ variant.discount }}%</span>
                                {% endif %}
                            </p>
                            <p class="mb-4">
                                <strong>В наличии:</strong>
                                {% if variant.quantity > 0 %}
                                    <span class="text-success fw-bold" id="variant-quantity">{{ variant.quantity }}</span>
                                {% else %}
                                    <span class="text-danger fw-bold" id="variant-quantity">Нет в наличии</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        <div id="selection-mode" class="d-flex gap-2 align-items-center mb-4">
                            <label class="btn btn-outline-dark active" id="color-first-label">
                                <input type="radio" name="mode" value="color-first" class="d-none" checked>
                                Цвет → Размер
                            </label>
                            <label class="btn btn-outline-dark" id="size-first-label">
                                <input type="radio" name="mode" value="size-first" class="d-none">
                                Размер → Цвет
                            </label>
                        </div>

                        {% if variants_data %}
                        <div id="variant-selectors" class="p-3 border rounded shadow-sm bg-light">
                            <!-- Выбор цвета -->
                            <div id="color-container" class="mb-4">
                                <label for="color-select" class="form-label fw-semibold">Выберите цвет:</label>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="color-preview"
                                        id="current-color"
                                        style="width: 40px; height: 40px;
                                                background-color: {{ variant.color_code }};
                                                border: 2px solid #dee2e6;
                                                border-radius: 8px;">
                                    </div>
                                    <select class="form-select w-auto" id="color-select"  name="color" style="min-width: 150px;">
                                        <!-- Цвета подставляются через JS -->
                                    </select>
                                </div>
                            </div>

                            <!-- Выбор размера -->
                            <div id="size-container" class="mb-2">
                                <label for="size-select" class="form-label fw-semibold">Выберите размер:</label>
                                <select class="form-select w-auto" id="size-select" name="size" style="min-width: 150px;">
                                    {% for size, variants in variants_data.sizes.items %}
                                        <option value="{{ size }}" {% if size == variant.size|lower %}selected{% endif %}>
                                            {{ size|upper }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}

                    {% if product.description %}
                        <p class="mt-3">{{ product.description|linebreaks }}</p>
                    {% endif %}
                    {% if variant.description %}
                        <p class="mt-3" id="variant-description">{{ variant.description|linebreaksbr  }}</p>
                    {% else %}
                        <p class="mt-3" id="variant-description" style="display: none;"></p>
                    {% endif %}

                    <a href="{% url 'carts:cart_add' %}"
                       id="add-to-cart-button"
                       class="btn btn-success btn-lg add-to-cart mt-3"
                       data-product-id="{{ variant.id }}">
                        <i class="bi bi-cart-plus me-2"></i> Добавить в корзину
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const galleryElem = document.getElementById("lightgallery");
    if (galleryElem) {
        lightGallery(galleryElem, {
            plugins: [lgZoom],
            speed: 400,
            zoom: true
        });
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Радиокнопки режима выбора (size-first / color-first)
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    // Кнопки режима (label) для визуального переключения
    const modeButtons = document.querySelectorAll('#selection-mode label');
    const selectorsContainer = document.getElementById("variant-selectors");
    const colorContainer = document.getElementById("color-container");
    const sizeContainer = document.getElementById("size-container");

    // Элементы для выбора варианта
    const colorSelect = document.getElementById("color-select");
    const sizeSelect = document.getElementById("size-select");

    // Элементы для отображения информации о варианте
    const skuEl = document.getElementById("variant-sku");
    const priceEl = document.getElementById("variant-price");
    const oldPriceEl = document.getElementById("variant-old-price");
    const discountEl = document.getElementById("variant-discount");
    const quantityEl = document.getElementById("variant-quantity");
    const descriptionEl = document.getElementById("variant-description");
    const addToCartButton = document.getElementById("add-to-cart-button");
    const current_color = document.getElementById("current-color");

    // Данные о вариантах товара
    const variantsData = JSON.parse('{{ variants_data|safe|escapejs }}');

    // Получение текущего режима
    function getMode() {
        return [...modeRadios].find(r => r.checked).value;
    }

    // Обновление порядка контейнеров селекторов
    function updateSelectors() {
        const selectedMode = document.querySelector('input[name="mode"]:checked').value;

        if (selectedMode === "color-first") {
            // Перемещаем colorContainer перед sizeContainer
            selectorsContainer.insertBefore(colorContainer, sizeContainer);
        } else {
            // Перемещаем sizeContainer перед colorContainer
            selectorsContainer.insertBefore(sizeContainer, colorContainer);
        }
    }


    // Поиск конкретного варианта по размеру и цвету
    function findVariant(size, color) {
        if (getMode() === "size-first") {
            const variants = variantsData.sizes[size] || [];
            return variants.find(v => v.color === color);
        } else {
            const variants = variantsData.colors[color] || [];
            return variants.find(v => v.size === size);
        }
    }

    // Обновление списка размеров для выбранного цвета
    function updateSizesForColor(selectedColor) {
        const sizes = variantsData.colors[selectedColor] || [];
        sizeSelect.innerHTML = "";
        sizes.forEach(variant => {
            const option = document.createElement("option");
            option.value = variant.size;
            option.textContent = variant.size;
            sizeSelect.appendChild(option);
        });
        if (sizes.length > 0) {
            sizeSelect.value = sizes[0].size;
            updateVariantInfo(sizes[0].size, selectedColor);
        }
    }

    // Обновление списка цветов для выбранного размера
    function updateColorsForSize(selectedSize) {
        const colors = variantsData.sizes[selectedSize] || [];
        colorSelect.innerHTML = "";
        colors.forEach(variant => {
            const option = document.createElement("option");
            option.value = variant.color;
            option.textContent = variant.color;
            option.style.backgroundColor = variant.color_code || "transparent";
            colorSelect.appendChild(option);
        });
        if (colors.length > 0) {
            colorSelect.value = colors[0].color;
            updateVariantInfo(selectedSize, colors[0].color);
        }
    }

    // Обновление информации о выбранном варианте
    function updateVariantInfo(size, color) {
        const variant = findVariant(size, color);
        if (!variant) return;

        skuEl.textContent = variant.sku;
        priceEl.textContent = `${variant.sell_price} ₽`;

        if (!variant.color_code) {
            current_color.style.display = "none";
        } else {
            current_color.style.display = "";
            current_color.style.backgroundColor = variant.color_code;
        }

        if (variant.discount && parseFloat(variant.discount) > 0) {
            oldPriceEl.textContent = `${variant.price} ₽`;
            oldPriceEl.style.display = "";
            discountEl.textContent = `-${variant.discount}%`;
            discountEl.style.display = "";
        } else {
            oldPriceEl.style.display = "none";
            discountEl.style.display = "none";
        }

        if (parseInt(variant.quantity) > 0) {
            quantityEl.classList.remove("text-danger");
            quantityEl.classList.add("text-success");
            quantityEl.textContent = variant.quantity;
            addToCartButton.disabled = false;
            addToCartButton.classList.remove("disabled");
        } else {
            quantityEl.textContent = "Нет в наличии";
            quantityEl.classList.remove("text-success");
            quantityEl.classList.add("text-danger");
            addToCartButton.disabled = true;
            addToCartButton.classList.add("disabled");
        }

        descriptionEl.innerHTML = (variant.description || "").replace(/\n/g, "<br>");
        addToCartButton.setAttribute("data-product-id", variant.id);
        $(addToCartButton).data("product-id", variant.id);
    }

    // Инициализация выбора вариантов
    function init() {

        if (getMode() === "size-first") {
            sizeSelect.innerHTML = "";
            Object.keys(variantsData.sizes).forEach(size => {
                const option = document.createElement("option");
                option.value = size;
                option.textContent = size;
                sizeSelect.appendChild(option);
            });
            if (sizeSelect.options.length > 0) {
                sizeSelect.value = sizeSelect.options[0].value;
                updateColorsForSize(sizeSelect.value);
            }
        } else {
            colorSelect.innerHTML = "";
            Object.keys(variantsData.colors).forEach(color => {
                const option = document.createElement("option");
                option.value = color;
                option.textContent = color;
                option.style.backgroundColor = variantsData.colors[color][0].color_code || "transparent";
                colorSelect.appendChild(option);
            });
            if (colorSelect.options.length > 0) {
                colorSelect.value = colorSelect.options[0].value;
                updateSizesForColor(colorSelect.value);
            }
        }
        updateSelectors();

    }

    // События переключения режима
    modeRadios.forEach(radio => {
        radio.addEventListener("change", init);
    });

    modeButtons.forEach(label => {
        label.addEventListener('click', () => {
            modeButtons.forEach(btn => btn.classList.remove('active'));
            label.classList.add('active');
            init();
        });
    });

    sizeSelect.addEventListener("change", function () {
        if (getMode() === "size-first") {
            updateColorsForSize(this.value);
        } else {
            updateVariantInfo(this.value, colorSelect.value);
        }
    });

    colorSelect.addEventListener("change", function () {
        if (getMode() === "color-first") {
            updateSizesForColor(this.value);
        } else {
            updateVariantInfo(sizeSelect.value, this.value);
        }
    });

    // Запуск инициализации при загрузке страницы
    init();
});
</script>

<style>
.color-box {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 3px;
    margin-right: 8px;
    border: 1px solid #ccc;
}
</style>

{% endblock %}

