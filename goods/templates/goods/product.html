{% extends "base.html" %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet">

<div class="container py-5">
    <div class="card shadow border-0 mb-5">
        <div class="row g-4 p-4 align-items-start">

            <!-- Галерея -->
            <div class="col-lg-6">
                <div class="mb-3">
                    <img
                        src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'deps/images/Not found image.png' %}{% endif %}"
                        class="img-fluid rounded w-100"
                        alt="{{ product.name }}">
                </div>

                {% if product.image or product.images.all %}
                <div class="d-flex flex-wrap gap-2" id="lightgallery">
                    {% if product.image %}
                        <a href="{{ product.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ product.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endif %}

                    {% for image in product.images.all %}
                        <a href="{{ image.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ image.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Информация о товаре -->
            <div class="col-lg-6">
                <div class="card-body">

                    <h2 class="card-title fw-bold mb-3">{{ product.name }}</h2>

                    <p class="card-text text-muted small mb-2">
                        Артикул: {{ product.display_id }}
                    </p>

                    {% if product.firm %}
                        <p class="card-text mb-2"><strong>Производитель:</strong> {{ product.firm }}</p>
                    {% endif %}

                    {% if product.composition %}
                        <p class="card-text mb-2"><strong>Состав:</strong> {{ product.composition }}</p>
                    {% endif %}

                    {% if product.model %}
                        <p class="card-text mb-2"><strong>Модель:</strong> {{ product.model }}</p>
                    {% endif %}

                    {% if product.country %}
                        <p class="card-text mb-2"><strong>Страна:</strong> {{ product.country }}</p>
                    {% endif %}

                    <!--Выводим информацию о варианте продукта-->
                    {% if variant %}
                        <div id="variant-info">
                            <p class="mb-2"><strong>Цвет:</strong> <span id="variant-color">{{ variant.color }}</span></p>
                            <p class="mb-2"><strong>Размер:</strong> <span id="variant-size">{{ variant.size }}</span></p>
                            <p class="mb-2"><strong>Артикул:</strong> <span id="variant-sku">{{ variant.sku }}</span></p>
                            <p class="mb-2">
                                <strong>Цена:</strong>
                                {% if variant.discount and variant.discount > 0 %}
                                    <span class="text-success fw-bold" id="variant-price">{{ variant.sell_price }} ₽</span>
                                    <span class="text-muted text-decoration-line-through ms-2" id="variant-old-price">{{ variant.price }} ₽</span>
                                    <span class="badge bg-warning ms-2" id="variant-discount">-{{ variant.discount }}%</span>
                                {% else %}
                                    <span id="variant-price">{{ variant.sell_price }} ₽</span>
                                {% endif %}
                            </p>
                            <p class="mb-4">
                                <strong>В наличии:</strong>
                                {% if variant.quantity > 0 %}
                                    <span class="text-success fw-bold" id="variant-quantity">{{ variant.quantity }}</span>
                                {% else %}
                                    <span class="text-danger fw-bold" id="variant-quantity">Нет в наличии</span>
                                {% endif %}
                            </p>
                        </div>

                        <!-- Выбор цвета и размера -->
                        {% if colors %}
                        <select class="form-select" id="color-select" name="color">
                            {% for color in colors %}
                            <option value="{{ color }}" {% if color == variant.color %}selected{% endif %}>{{ color }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}

                        {% if sizes %}
                        <select class="form-select" id="size-select" name="size">
                            {% for size in sizes %}
                                <option value="{{ size }}" {% if size == variant.size %}selected{% endif %}>{{ size }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}


                    {% endif %}

                    {% if product.description %}
                        <p class="card-text mb-4">{{ product.description }}</p>
                    {% endif %}

                    <a href="{% url 'carts:cart_add' %}"
                        id="add-to-cart-button"
                        class="btn btn-success btn-lg add-to-cart mt-3"
                        data-product-id="{{ variant.id }}">
                        {% csrf_token %}
                        <i class="bi bi-cart-plus me-2"></i>
                        Добавить в корзину 
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const galleryElem = document.getElementById("lightgallery");
    if (galleryElem) {
        lightGallery(galleryElem, {
            plugins: [lgZoom],
            speed: 400,
            zoom: true,
            thumbnail: false
        });
    }
});
</script>

<script id="variants-json" type="application/json">
    {{ variants_json|safe }}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const colorSelect = document.getElementById("color-select");
    const sizeSelect = document.getElementById("size-select");

    const variants = JSON.parse(document.getElementById("variants-json").textContent);

    colorSelect.addEventListener("change", updateVariant);
    sizeSelect.addEventListener("change", updateVariant);

    function updateVariant() {
        const selectedColor = colorSelect.value;
        const selectedSize = sizeSelect.value;

        const variant = variants.find(v =>
            v.color === selectedColor && v.size === selectedSize
        );

        const priceElem = document.getElementById("variant-price");
        const oldPriceElem = document.getElementById("variant-old-price");
        const discountBadge = document.getElementById("variant-discount");
        const quantityElem = document.getElementById("variant-quantity");
        const variantcolorElem = document.getElementById("variant-color");
        const variantsizeElem = document.getElementById("variant-size");
        const variantskuElem = document.getElementById("variant-sku");

        const button = document.getElementById("add-to-cart-button");

        variantcolorElem.textContent = selectedColor;
        variantsizeElem.textContent = selectedSize;
        
        button.setAttribute("data-product-id", variant ? variant.id : "");


        if (variant) {

            variantskuElem.textContent = variant.sku;

            if (variant.discount && parseFloat(variant.discount) > 0) {
                priceElem.textContent = variant.sell_price + " ₽";
                oldPriceElem.textContent = variant.price + " ₽";
                discountBadge.textContent = "-" + variant.discount + "%";
                oldPriceElem.style.display = "";
                discountBadge.style.display = "";
                priceElem.classList.remove("text-danger");
                priceElem.classList.add("text-success");
            } else {
                priceElem.textContent = variant.sell_price + " ₽";
                oldPriceElem.style.display = "none";
                discountBadge.style.display = "none";
            }

            if (variant.quantity > 0) {
                quantityElem.textContent = variant.quantity;
                quantityElem.classList.remove("text-danger");
                quantityElem.classList.add("text-success");
            } else {
                quantityElem.textContent = "Нет в наличии";
                quantityElem.classList.remove("text-success");
                quantityElem.classList.add("text-danger");
            }
            button.classList.remove("disabled");
        }
        else {
            priceElem.textContent = "Нет в наличии";
            priceElem.classList.remove("text-success");
            priceElem.classList.add("text-danger");

            quantityElem.textContent = "Нет в наличии";
            quantityElem.classList.remove("text-success");
            quantityElem.classList.add("text-danger");
``
            variantskuElem.textContent = "Нет в наличии";

            oldPriceElem.style.display = "none";
            discountBadge.style.display = "none";
            button.classList.add("disabled");
        }
    }
});
</script>
{% endblock %}