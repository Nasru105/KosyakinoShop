{% extends "base.html" %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet">

<div class="container py-4">

    <div class="row align-items-center mb-4">
        <div class="col d-flex flex-wrap gap-3">
            <!-- Каталог -->
            <div class="dropdown">
                <button class="btn btn-dark dropdown-toggle d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <span>Каталог</span>
                    <img class="ms-2" src="{% static 'deps/icons/grid-fill.svg' %}" alt="Catalog Icon" width="16" height="16">
                </button>
                {% include "includes/catalog_dropdown.html" %}
            </div>

            <!-- Корзина -->
            {% include "includes/cart_button.html" %}

            {% if user.is_admin or user.is_staff %}
            <div class="row mb-4">
                <div class="col">
                    <a href="{% url 'admin:goods_product_change' variant.product.id %}" 
                    class="btn btn-dark d-inline-flex align-items-center">
                        Редактировать в админке
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card shadow border-0 mb-5">
        <div class="row g-4 p-4 align-items-start">

            <!-- Галерея -->
            <div class="col-lg-6">
                <div class="mb-3">
                    <img
                        src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'deps/images/Not found image.png' %}{% endif %}"
                        class="img-fluid rounded w-100"
                        alt="{{ product.name }}">
                </div>

                {% if product.image or product.images.all %}
                <div class="d-flex flex-wrap gap-2" id="lightgallery">
                    {% if product.image %}
                        <a href="{{ product.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ product.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endif %}

                    {% for image in product.images.all %}
                        <a href="{{ image.image.url }}" class="flex-shrink-0" data-lg-size="1400-933">
                            <img src="{{ image.image.url }}"
                                 class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 alt="{{ product.name }}">
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Информация о товаре -->
            <div class="col-lg-6">
                <div class="card-body">

                    <h2 class="card-title fw-bold mb-3">{{ product.name }}</h2>


                    {% if product.firm %}
                        <p class="mb-2"><strong>Производитель:</strong> {{ product.firm }}</p>
                    {% endif %}

                    {% if product.composition %}
                        <p class="mb-2"><strong>Состав:</strong> {{ product.composition }}</p>
                    {% endif %}

                    {% if product.model %}
                        <p class="mb-2"><strong>Модель:</strong> {{ product.model }}</p>
                    {% endif %}

                    {% if product.country %}
                        <p class="mb-2"><strong>Страна:</strong> {{ product.country }}</p>
                    {% endif %}

                    {% if variant %}
                        <div id="variant-info">
                            <p class="mb-2"><strong>Артикул:</strong> <span id="variant-sku">{{ variant.sku }}</span></p>
                            <p class="mb-2">
                                <strong>Цена:</strong>
                                {% if variant.discount and variant.discount > 0 %}
                                    <span class="fs-4 text-success fw-bold" id="variant-price">{{ variant.sell_price }} ₽</span>
                                    <span class="text-muted text-decoration-line-through ms-2" id="variant-old-price">{{ variant.price }} ₽</span>
                                    <span class="badge bg-warning ms-2" id="variant-discount">-{{ variant.discount }}%</span>
                                {% else %}
                                    <span  id="variant-price" class="fs-4 fw-bold">{{ variant.sell_price }} ₽</span>
                                    <span id="variant-old-price" class="text-muted text-decoration-line-through ms-2" style="display: none;">{{ variant.price }} ₽</span>
                                    <span id="variant-discount" class="badge bg-warning ms-2" style="display: none;">-{{ variant.discount }}%</span>
                                {% endif %}
                            </p>
                            <p class="mb-4">
                                <strong>В наличии:</strong>
                                {% if variant.quantity > 0 %}
                                    <span class="text-success fw-bold" id="variant-quantity">{{ variant.quantity }}</span>
                                {% else %}
                                    <span class="text-danger fw-bold" id="variant-quantity">Нет в наличии</span>
                                {% endif %}
                            </p>
                        </div>

                        {% if variants_color_json %}
                        <div class="mb-3">
                            <label for="color-select" class="form-label">Выберите цвет:</label>
                            <select class="form-select" id="color-select" name="color">
                                {% for color in variants_color_json %}
                                    <option value="{{ color }}" {% if color == variant.color %}selected{% endif %}>{{ color }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="size-select" class="form-label">Выберите размер:</label>
                            <select class="form-select" id="size-select" name="size">
                                <!-- Здесь будут размеры подставляться через JS -->
                            </select>
                        </div>
                        {% endif %}
                    {% endif %}

                    {% if product.description %}
                        <p class="mt-3">{{ product.description }}</p>
                    {% endif %}
                    {% if variant.description %}
                        <p class="mt-3" id="variant-description">{{ variant.description }}</p>
                    {% else %}
                        <p class="mt-3" id="variant-description" style="display: none;"></p>
                    {% endif %}

                    <a href="{% url 'carts:cart_add' %}"
                       id="add-to-cart-button"
                       class="btn btn-success btn-lg add-to-cart mt-3"
                       data-product-id="{{ variant.id }}">
                        <i class="bi bi-cart-plus me-2"></i> Добавить в корзину
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const galleryElem = document.getElementById("lightgallery");
    if (galleryElem) {
        lightGallery(galleryElem, {
            plugins: [lgZoom],
            speed: 400,
            zoom: true
        });
    }
});
</script>

<script id="variants-json" type="application/json">
    {{ variants_json|safe }}
</script>

<script>
    const variantsData = {{ variants_color_json_str|safe }};
    const colorSelect = document.getElementById("color-select");
    const sizeSelect = document.getElementById("size-select");

    const skuEl = document.getElementById("variant-sku");
    const priceEl = document.getElementById("variant-price");
    const oldPriceEl = document.getElementById("variant-old-price");
    const discountEl = document.getElementById("variant-discount");
    const quantityEl = document.getElementById("variant-quantity");
    const descriptionEl = document.getElementById("variant-description");
    const addToCartButton = document.getElementById("add-to-cart-button");

    function findVariant(color, size) {
        const variants = variantsData[color] || [];
        return variants.find(v => v.size === size);
    }

    function updateSizes(selectedColor) {
        const sizes = variantsData[selectedColor] || [];
        sizeSelect.innerHTML = "";

        sizes.forEach(variant => {
            const option = document.createElement("option");
            option.value = variant.size;
            option.textContent = variant.size;
            sizeSelect.appendChild(option);
        });

        // Обновить данные на основе первого размера
        if (sizes.length > 0) {
            sizeSelect.value = sizes[0].size;
            updateVariantInfo(selectedColor, sizes[0].size);
        }
    }

    function updateVariantInfo(color, size) {
        const variant = findVariant(color, size);
        if (!variant) return;

        skuEl.textContent = variant.sku;
        priceEl.textContent = `${variant.sell_price} ₽`;

        if (variant.discount && parseFloat(variant.discount) > 0) {
            oldPriceEl.textContent = `${variant.price} ₽`;
            oldPriceEl.style.display = "";
            discountEl.textContent = `-${variant.discount}%`;
            discountEl.style.display = "";
        } else {
            oldPriceEl.style.display = "none";
            discountEl.style.display = "none";
        }

        if (parseInt(variant.quantity) > 0) {
            quantityEl.textContent = variant.quantity;
            quantityEl.classList.remove("text-danger");
            quantityEl.classList.add("text-success");
            quantityEl.textContent = variant.quantity;
        } else {
            quantityEl.textContent = "Нет в наличии";
            quantityEl.classList.remove("text-success");
            quantityEl.classList.add("text-danger");
        }

        descriptionEl.textContent = variant.description || "";

        // обновить data-product-id у кнопки "добавить в корзину"
        addToCartButton.setAttribute("data-product-id", variant.id);
        $(addToCartButton).data("product-id", variant.id);  // <-- это обязательно!

    }

    // инициализация при загрузке
    document.addEventListener("DOMContentLoaded", function () {
        updateSizes(colorSelect.value);
    });

    colorSelect.addEventListener("change", function () {
        const selectedColor = this.value;
        updateSizes(selectedColor);
    });

    sizeSelect.addEventListener("change", function () {
        const selectedColor = colorSelect.value;
        const selectedSize = this.value;
        updateVariantInfo(selectedColor, selectedSize);
    });
</script>


{% endblock %}
